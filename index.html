<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Вход | ProStroy</title>
  <style>
    html,body{height:100%;margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;color:#fff}
    body{background:#0b1220;overflow:hidden}
    video.bg{
      position:fixed;top:0;left:0;width:100%;height:100%;
      object-fit:cover;z-index:-1
    }
    .wrap{min-height:100%;display:grid;place-items:center;padding:24px}
    .card{width:min(92vw, 820px);padding:28px 32px;border-radius:18px;background:rgba(0,0,0,.55);border:1px solid rgba(255,255,255,.18)}
    h1{margin:0 0 8px;text-align:center}
    .subtitle{margin:0 0 18px;text-align:center;color:#cbd5e1}
    label{display:block;margin:10px 0 6px}
    .field{position:relative}
    input{width:100%;height:48px;border-radius:12px;border:1px solid rgba(255,255,255,.25);background:rgba(255,255,255,.12);color:#fff;padding:12px 44px 12px 14px}
    input:focus{outline:none;border-color:#1ed760;box-shadow:0 0 0 4px rgba(30,215,96,.18)}
    .eye{position:absolute;right:8px;top:50%;transform:translateY(-50%);width:34px;height:34px;border:none;background:transparent;cursor:pointer}
    .eye svg{width:20px;height:20px;fill:#e5e7eb}
    .btn{margin-top:16px;width:100%;height:48px;border:none;border-radius:12px;background:#1ed760;color:#062410;font-weight:800;cursor:pointer}
    .btn:hover{filter:brightness(1.05)}
    #err{margin-top:10px;color:#ff7a7a;min-height:20px;text-align:center}
    #status{margin-top:10px;color:#7dd3fc;font-size:13px;white-space:pre-wrap}
  </style>
</head>
<body>
  <!-- Видео-фон -->
  <video class="bg" autoplay muted loop playsinline>
    <source src="https://assets.mixkit.co/videos/30431/30431-720.mp4" type="video/mp4">
  </video>

  <div class="wrap">
    <div class="card">
      <h1>Вход в систему</h1>
      <p class="subtitle">ProStroy</p>

      <form id="loginForm">
        <label for="email">Email</label>
        <div class="field">
          <input id="email" type="email" placeholder="user@prostroy.ru" autocomplete="username" required>
        </div>

        <label for="password">Пароль</label>
        <div class="field">
          <input id="password" type="password" placeholder="••••••••" autocomplete="current-password" required>
          <button type="button" class="eye" id="togglePwd" aria-label="Показать пароль">
            <svg viewBox="0 0 24 24"><path d="M12 5C5 5 1.5 12 1.5 12S5 19 12 19s10.5-7 10.5-7S19 5 12 5zm0 10a3 3 0 110-6 3 3 0 010 6z"/></svg>
          </button>
        </div>

        <button class="btn" type="submit">Войти</button>
        <div id="err"></div>
        <div id="status"></div>
      </form>
    </div>
  </div>

  <!-- Supabase -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script>
    // ===== УТИЛИТЫ =====
    function base(path){
      const repo = '/ProStroy/';
      const pref = location.pathname.startsWith(repo) ? repo : '/';
      return pref + path;
    }
    function log(msg){
      console.log(msg);
      const s = document.getElementById('status');
      s.textContent += (s.textContent ? '\n' : '') + msg;
    }

    // ===== ПАРОЛЬ — ГЛАЗ =====
    (()=>{
      const pwd = document.getElementById('password');
      const btn = document.getElementById('togglePwd');
      btn.addEventListener('click', ()=>{
        pwd.type = (pwd.type === 'password') ? 'text' : 'password';
      });
    })();

    // ===== SUPABASE КЛИЕНТ =====
    const SB_URL  = "https://hvpbwpegxcbstmpngdyc.supabase.co";
    const SB_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh2cGJ3cGVneGNic3RtcG5nZHljIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg2NDE4NjMsImV4cCI6MjA3NDIxNzg2M30.rtPrQVsaEFA-ee1RphLKKn8q3TSOXeapZnZgfe9HVws";
    const supa = supabase.createClient(SB_URL, SB_ANON, { auth:{ persistSession:true } });

    // ===== УЖЕ АВТОРИЗОВАН? СРАЗУ НА ГЛАВНУЮ =====
    (async ()=>{
      const { data:{ session }, error } = await supa.auth.getSession();
      if(error){ log('getSession error: ' + error.message); }
      if(session){
        log('Session found. Redirect to main.html');
        location.replace(base('main.html'));
      }else{
        log('No session yet. Waiting for user input.');
      }
    })();

    // ===== ЛОГИН =====
    document.getElementById('loginForm').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const email = document.getElementById('email').value.trim();
      const password = document.getElementById('password').value;
      const errEl = document.getElementById('err');
      errEl.textContent = '';
      log('Try login for ' + email);

      const { data, error } = await supa.auth.signInWithPassword({ email, password });
      if(error){
        errEl.textContent = error.message || 'Ошибка входа';
        log('signIn error: ' + errEl.textContent);
        return;
      }
      log('signIn ok, waiting for session…');

      for(let i=0;i<10;i++){
        const { data:{ session } } = await supa.auth.getSession();
        if(session){
          log('Session ready. Redirecting…');
          location.replace(base('main.html'));
          return;
        }
        await new Promise(r=>setTimeout(r,120));
      }
      errEl.textContent = 'Сессия не появилась. Проверь настройки Auth в Supabase.';
      log('No session after signIn — check Email provider / user confirmed');
    });
  </script>
</body>
</html>
