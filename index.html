<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Вход | ProStroy</title>

<!-- 1) Библиотека Supabase (UMD) -->
<!-- Важно: type="module" тут НЕ нужен. Эта сборка кладёт объект supabase в window -->
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>

<style>
  /* БАЗОВЫЕ СТИЛИ — можно править на вкус */
  *,*::before,*::after{box-sizing:border-box}
  html,body{height:100%;margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;color:#fff;overflow:hidden}

  /* Фон-видео */
  .bg video{position:fixed;inset:0;width:100vw;height:100vh;object-fit:cover;z-index:-2}
  .overlay{position:fixed;inset:0;background:rgba(0,0,0,.55);z-index:-1}

  /* Карточка входа */
  .wrap{height:100%;display:grid;place-items:center;padding:24px}
  .card{
    width:min(92vw, 900px);
    padding:36px 40px; border-radius:20px;
    background:rgba(255,255,255,.10);
    backdrop-filter:blur(14px) saturate(140%);
    -webkit-backdrop-filter:blur(14px) saturate(140%);
    border:1px solid rgba(255,255,255,.18);
    box-shadow:0 10px 30px rgba(0,0,0,.35)
  }
  h1{margin:0 0 6px;font-size:40px;text-align:center}
  .subtitle{margin:0 0 28px;text-align:center;color:#d1d5db}

  .form{max-width:720px;margin:0 auto}
  .row{margin-bottom:16px}
  label{display:block;margin-bottom:8px;font-size:15px;color:#e5e7eb}

  .field{position:relative}
  input[type="email"],input[type="password"]{
    width:100%;height:52px;padding:14px 48px 14px 16px;
    border-radius:12px;border:1px solid rgba(255,255,255,.25);
    background:rgba(255,255,255,.14);color:#fff;outline:none
  }
  input::placeholder{color:#cbd5e1}
  input:focus{box-shadow:0 0 0 4px rgba(34,197,94,.18);border-color:rgba(34,197,94,.7)}

  .eye{position:absolute;right:12px;top:50%;transform:translateY(-50%);
       width:28px;height:28px;display:grid;place-items:center;
       background:transparent;border:none;cursor:pointer;outline:none}
  .eye svg{width:22px;height:22px;fill:#e5e7eb;opacity:.9}

  .controls{max-width:720px;margin:6px auto 0}
  .remember-line{display:flex;align-items:center;gap:10px}
  .remember-line span{font-size:15px}
  .remember-line input[type="checkbox"]{
    margin-left:auto;width:18px;height:18px;accent-color:#22c55e;cursor:pointer
  }
  .forgot{margin-top:6px;text-align:right}
  .forgot a{color:#7dd3fc;text-decoration:none;font-size:15px}

  .btn{display:block;width:100%;max-width:720px;margin:16px auto 0;height:52px;
       border:none;border-radius:12px;background:#22c55e;color:#fff;
       font-weight:800;letter-spacing:.2px;cursor:pointer}
  .btn:hover{background:#16a34a}
  .btn:disabled{opacity:.6;cursor:not-allowed}

  #err{margin-top:8px;color:#ff7a7a;min-height:20px}
</style>
</head>
<body>
  <!-- Фон-видео (можно заменить ссылку на свою) -->
  <div class="bg">
    <video autoplay muted loop playsinline>
      <source src="https://assets.mixkit.co/videos/30431/30431-720.mp4" type="video/mp4">
    </video>
  </div>
  <div class="overlay"></div>

  <div class="wrap">
    <div class="card">
      <h1>Вход в систему</h1>
      <p class="subtitle">ProStroy</p>

      <!-- 2) Форма входа. Делаем вход ЧЕРЕЗ JS (onsubmit). Никаких action не нужно -->
      <form class="form" id="loginForm">
        <div class="row">
          <label for="login">E-mail</label>
          <div class="field">
            <input id="login" name="login" type="email" placeholder="boss@prostroy.ru" autocomplete="username" required>
          </div>
        </div>

        <div class="row">
          <label for="password">Пароль</label>
          <div class="field">
            <input id="password" name="password" type="password" placeholder="••••••••" autocomplete="current-password" required>
            <button type="button" class="eye" id="togglePwd" aria-label="Показать пароль">
              <svg id="eyeOpen" viewBox="0 0 24 24"><path d="M12 5C5 5 1.5 12 1.5 12S5 19 12 19s10.5-7 10.5-7S19 5 12 5zm0 10a3 3 0 110-6 3 3 0 010 6z"/></svg>
              <svg id="eyeClosed" style="display:none" viewBox="0 0 24 24"><path d="M3.27 2L2 3.27 5.73 7C3.73 8.34 2.31 10.04 1.5 12c0 0 3.5 7 10.5 7 2.08 0 3.9-.43 5.47-1.16l3.76 3.76L22 20.73 3.27 2zM12 7a5 5 0 014.9 6.09l-1.73-1.73A3 3 0 0012 9a3 3 0 00-2.36 1.18L7.41 8c1.12-.62 2.47-1 4.59-1z"/></svg>
            </button>
          </div>
        </div>

        <!-- НЕобязательные скрытые поля — пригодятся если начнёшь логировать -->
        <input type="hidden" name="client_ts" id="client_ts">
        <input type="hidden" name="user_agent" id="user_agent">
        <input type="hidden" name="source_page" id="source_page">
        <input type="hidden" name="form_version" value="prostroy-login-v1">

        <div class="controls">
          <label class="remember-line" for="remember">
            <span>Запомнить e-mail</span>
            <input id="remember" type="checkbox" name="remember" value="1">
          </label>
          <div class="forgot"><a href="#" id="restoreLink">Забыли пароль?</a></div>
        </div>

        <button class="btn" id="loginBtn" type="submit">Войти</button>
        <div id="err"></div>
      </form>
    </div>
  </div>

<script>
  /* ==========================
     3) НАСТРОЙКА SUPABASE
     ========================== */

  // !!! ЗАМЕНИ на свои значения !!!
  const SUPABASE_URL = "https://hvpbwpegxcbstmpngdyc.supabase.co"; // <-- твой Project URL
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh2cGJ3cGVneGNic3RtcG5nZHljIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg2NDE4NjMsImV4cCI6MjA3NDIxNzg2M30.rtPrQVsaEFA-ee1RphLKKn8q3TSOXeapZnZgfe9HVws"; // <-- твой anon key

  // Клиент Supabase
  const supa = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  /* ==========================
     4) ПОВЕДЕНИЕ СТРАНИЦЫ
     ========================== */

  // a) Если пользователь уже залогинен — сразу отправляем на main.html
  (async () => {
    try {
      const { data: { session }, error } = await supa.auth.getSession();
      if (error) console.warn(error);
      if (session) {
        location.href = 'main.html'; // Файл main.html должен лежать рядом с index.html
      }
    } catch(e){ console.error(e); }
  })();

  // b) Обработчик отправки формы логина
  const form = document.getElementById('loginForm');
  const btn = document.getElementById('loginBtn');
  const errEl = document.getElementById('err');

  // Метаданные (необязательно)
  document.getElementById('client_ts').value = new Date().toISOString();
  document.getElementById('user_agent').value = navigator.userAgent;
  document.getElementById('source_page').value = location.href;

  // Подтягиваем email из localStorage если включали "Запомнить"
  const savedEmail = localStorage.getItem('prostroy_email');
  if (savedEmail) {
    document.getElementById('login').value = savedEmail;
    document.getElementById('remember').checked = true;
  }

  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    errEl.textContent = '';

    const email = document.getElementById('login').value.trim();
    const password = document.getElementById('password').value.trim();
    const remember = document.getElementById('remember').checked;

    if (!email) { errEl.textContent = 'Введите e-mail.'; return; }
    if (!password) { errEl.textContent = 'Введите пароль.'; return; }

    // Блокируем кнопку на время запроса (анти-дубльклик)
    btn.disabled = true;

    // Логинимся в Supabase
    const { data, error } = await supa.auth.signInWithPassword({ email, password });

    // Возвращаем кнопку
    btn.disabled = false;

    if (error) {
      errEl.textContent = error.message || 'Не удалось войти. Проверьте e-mail и пароль.';
      return;
    }

    // Сохраняем e-mail если пользователь отметил чекбокс
    if (remember) localStorage.setItem('prostroy_email', email);
    else localStorage.removeItem('prostroy_email');

    // Успешно — на главную
    location.href = 'main.html';
  });

  // c) Переключатель "показать пароль"
  const pwd = document.getElementById('password');
  const openI = document.getElementById('eyeOpen');
  const closedI = document.getElementById('eyeClosed');
  document.getElementById('togglePwd').addEventListener('click',()=>{
    const show = pwd.type === 'password';
    pwd.type = show ? 'text' : 'password';
    openI.style.display = show ? 'none' : 'block';
    closedI.style.display = show ? 'block' : 'none';
  });

  // d) "Забыли пароль?" — отправка magic-link на почту (по желанию)
  // Работает, если в Supabase включена Email Auth и настроены шаблоны
  document.getElementById('restoreLink').addEventListener('click', async (e) => {
    e.preventDefault();
    const email = document.getElementById('login').value.trim();
    if (!email) { errEl.textContent = 'Введите e-mail в поле выше, чтобы восстановить доступ.'; return; }
    try{
      btn.disabled = true;
      const { error } = await supa.auth.resetPasswordForEmail(email, {
        redirectTo: location.origin + location.pathname.replace('index.html','') + 'reset.html' // сделай reset.html при желании
      });
      btn.disabled = false;
      if (error) { errEl.textContent = error.message; return; }
      errEl.style.color = '#ffd166';
      errEl.textContent = 'Если e-mail существует, письмо отправлено. Проверьте почту.';
      setTimeout(()=>{ errEl.style.color = '#ff7a7a'; }, 4000);
    } catch (e) {
      btn.disabled = false;
      errEl.textContent = 'Ошибка при отправке письма.';
    }
  });
</script>
</body>
</html>
