<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Вход | ProStroy</title>
  <style>
    *,*::before,*::after{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;color:#fff}
    /* BG video */
    .bg video{position:fixed;inset:0;width:100vw;height:100vh;object-fit:cover;z-index:-2}
    .overlay{position:fixed;inset:0;background:rgba(0,0,0,.55);z-index:-1}
    /* Card */
    .wrap{height:100%;display:grid;place-items:center;padding:24px}
    .card{width:min(92vw, 900px);max-width:900px;padding:36px 40px;border-radius:20px;
      background:rgba(255,255,255,.10);backdrop-filter:blur(14px) saturate(140%);
      -webkit-backdrop-filter:blur(14px) saturate(140%);
      border:1px solid rgba(255,255,255,.18);box-shadow:0 10px 30px rgba(0,0,0,.35)}
    h1{margin:0 0 6px;font-size:40px;text-align:center}
    .subtitle{margin:0 0 28px;text-align:center;color:#d1d5db}
    .form{max-width:720px;margin:0 auto}
    .row{margin-bottom:16px}
    label{display:block;margin-bottom:8px;font-size:15px;color:#e5e7eb}
    .field{position:relative}
    input[type="text"],input[type="email"],input[type="password"]{
      width:100%;height:52px;padding:14px 48px 14px 16px;
      border-radius:12px;border:1px solid rgba(255,255,255,.25);
      background:rgba(255,255,255,.14);color:#fff;outline:none}
    input::placeholder{color:#cbd5e1}
    input:focus{box-shadow:0 0 0 4px rgba(34,197,94,.18);border-color:rgba(34,197,94,.7)}
    /* Eye */
    .eye{position:absolute;right:12px;top:50%;transform:translateY(-50%);
      width:28px;height:28px;display:grid;place-items:center;
      background:transparent;border:none;cursor:pointer;outline:none}
    .eye svg{width:22px;height:22px;fill:#e5e7eb;opacity:.9}
    /* Controls */
    .controls{max-width:720px;margin:6px auto 0;text-align:right}
    .controls a{color:#7dd3fc;text-decoration:none;font-size:15px}
    .btn{display:block;width:100%;max-width:720px;margin:16px auto 0;height:52px;
      border:none;border-radius:12px;background:#22c55e;color:#062410;
      font-weight:800;cursor:pointer}
    .btn:hover{background:#16a34a}
    #err{margin-top:12px;min-height:22px;color:#ff7a7a;text-align:center}
  </style>
</head>
<body>
  <!-- Background -->
  <div class="bg">
    <video autoplay muted loop playsinline>
      <source src="https://assets.mixkit.co/videos/30431/30431-720.mp4" type="video/mp4">
    </video>
  </div>
  <div class="overlay"></div>

  <div class="wrap">
    <div class="card">
      <h1>Вход в систему</h1>
      <p class="subtitle">ProStroy</p>

      <form class="form" id="loginForm">
        <div class="row">
          <label for="email">Email</label>
          <div class="field">
            <input id="email" type="email" placeholder="user@prostroy.ru" autocomplete="username" required>
          </div>
        </div>

        <div class="row">
          <label for="password">Пароль</label>
          <div class="field">
            <input id="password" type="password" placeholder="••••••••" autocomplete="current-password" required>
            <button type="button" class="eye" id="togglePwd" aria-label="Показать пароль">
              <svg id="eyeOpen" viewBox="0 0 24 24"><path d="M12 5C5 5 1.5 12 1.5 12S5 19 12 19s10.5-7 10.5-7S19 5 12 5zm0 10a3 3 0 110-6 3 3 0 010 6z"/></svg>
              <svg id="eyeClosed" style="display:none" viewBox="0 0 24 24"><path d="M3.27 2L2 3.27 5.73 7C3.73 8.34 2.31 10.04 1.5 12c0 0 3.5 7 10.5 7 2.08 0 3.9-.43 5.47-1.16l3.76 3.76L22 20.73 3.27 2zM12 7a5 5 0 014.9 6.09l-1.73-1.73A3 3 0 0012 9a3 3 0 00-2.36 1.18L7.41 8c1.12-.62 2.47-1 4.59-1z"/></svg>
            </button>
          </div>
        </div>

        <div class="controls"><a href="#">Забыли пароль?</a></div>
        <button class="btn" type="submit">Войти</button>
        <div id="err"></div>
      </form>
    </div>
  </div>

  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script>
  // 0) Настройки
  const SB_URL  = "https://hvpbwpegxcbstmpngdyc.supabase.co";
  const SB_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh2cGJ3cGVneGNic3RtcG5nZHljIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg2NDE4NjMsImV4CI6MjA3NDIxNzg2M30.rtPrQVsaEFA-ee1RphLKKn8q3TSOXeapZnZgfe9HVws";

  // 1) Клиент: с persist=true, чтобы сессия не терялась при перезагрузке
  const supa = supabase.createClient(SB_URL, SB_ANON, { auth: { persistSession: true } });

  // 2) Если уже есть сессия — сразу на main (без миганий)
  (async () => {
    const { data: { session } } = await supa.auth.getSession();
    if (session) {
      location.replace('main.html');   // назад не вернет на логин
      return;
    }
  })();

  // 3) Глазик (если у тебя есть кнопка с id="togglePwd")
  (() => {
    const pwd = document.getElementById('password');
    const toggle = document.getElementById('togglePwd');
    if (pwd && toggle) {
      const eyeOpen = document.getElementById('eyeOpen');
      const eyeClosed = document.getElementById('eyeClosed');
      toggle.addEventListener('click', () => {
        const show = pwd.type === 'password';
        pwd.type = show ? 'text' : 'password';
        if (eyeOpen && eyeClosed) {
          eyeOpen.style.display = show ? 'none' : 'block';
          eyeClosed.style.display = show ? 'block' : 'none';
        }
      });
    }
  })();

  // 4) Логин — только через JS. В теге <form> не должно быть action=""
  const form = document.getElementById('loginForm');
  form?.addEventListener('submit', async (e) => {
    e.preventDefault(); // ВАЖНО: чтобы страница не перезагружалась
    const email = (document.getElementById('email')?.value || '').trim();
    const password = (document.getElementById('password')?.value || '').trim();
    const errEl = document.getElementById('err');
    if (errEl) errEl.textContent = '';

    // попытка входа
    const { data, error } = await supa.auth.signInWithPassword({ email, password });
    if (error) {
      if (errEl) errEl.textContent = error.message || 'Ошибка входа';
      return;
    }

    // иногда сессия появляется с микрозадержкой — подождём гарантированно
    for (let i = 0; i < 8; i++) {
      const { data: { session } } = await supa.auth.getSession();
      if (session) break;
      await new Promise(r => setTimeout(r, 120));
    }

    // Переходим на главную и «забываем» логин в истории
    location.replace('main.html');
  });
</script>
</body>
</html>
